#!/usr/bin/env bash
USER=$(whoami)
RSYNC=$(which rsync)
LOGGER_TAG="Rsync Wrapper"
LOGGER="$(which logger) -t $LOGGER_TAG"

$LOGGER "Starting rsync backup."
if [ -f /home/$USER/.env_vars ]; then
	source /home/$USER/.env_vars
else
	$LOGGER "env_vars not found"
	exit 1;
fi

if [ -f /home/$USER/.ssh/config ]; then
    $RSYNC -rl --exclude-from=/etc/turbo_happiness/rsync_exclude.conf $HOME -e ssh $USER.$BACKUP_SERVER:$BACKUP_PATH/$USER/rsync
    rsync_status="$?"
    if [ "$rsync_status" = "0" ]; then
        $LOGGER "complete for $USER"
        exit $rsync_status
    else
        $LOGGER "failed for $USER with exit status $rsync_status"
        exit $rsync_status
    fi
fi
$LOGGER "CONFIG: rsync wrapper fails config test."
